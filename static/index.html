<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8" />
    <title>Firefly III Alior BLIK Tool</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.11"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto bg-white p-6 rounded shadow space-y-6">
        <h1 class="text-2xl font-bold">Firefly Alior BLIK tool</h1>
       
        <!-- Upload CSV -->
        <form hx-post="/upload-csv" hx-target="#uploadResult" hx-swap="innerHTML" enctype="multipart/form-data">
            <div class="flex items-center space-x-4">
                <input type="file" name="file" class="border p-2" required />
                <button class="bg-blue-600 text-white px-4 py-2 rounded">Wyślij CSV</button>
            </div>
        </form>

        <div id="uploadResult"></div>
        <div id="csvPreview"></div>
        <div id="matchResults"></div>
    </div>

    <script>
document.body.addEventListener("htmx:afterOnLoad", function (evt) {
    const res = evt.detail.xhr.response;
    try {
        const data = JSON.parse(res);
        if (data.id) {
            const fileId = data.id;

            // wypełniamy uploadResult prostym statusem + dwoma przyciskami
            document.querySelector("#uploadResult").innerHTML = `
                <div class="p-4 bg-green-100 border border-green-300 rounded">
                    <div class="font-bold">Plik wczytany ✔</div>
                    <div>${data.count} rekordów</div>
                    <div class="mt-3 flex space-x-4">
                        <button hx-get="/file/${fileId}"
                                hx-target="#csvPreview"
                                class="bg-gray-700 text-white px-3 py-1 rounded">
                            Podgląd pliku
                        </button>

                        <button hx-get="/file/do-match/${fileId}"
                                hx-target="#matchResults"
                                class="bg-blue-600 text-white px-3 py-1 rounded">
                            Matchuj
                        </button>
                    </div>
                </div>
            `;

            // czyścimy pozostałe sekcje
            document.querySelector("#csvPreview").innerHTML = "";
            document.querySelector("#matchResults").innerHTML = "";
        }
    } catch (e) {
        console.error("Not a JSON response");
    }
});
</script>

<!-- LOGIN -->
<div id="loginBox" class="p-4">
  <input id="loginUser" placeholder="user" class="border p-1 mr-2" />
  <input id="loginPass" placeholder="password" type="password" class="border p-1 mr-2" />
  <button id="loginBtn" class="bg-indigo-600 text-white px-3 py-1 rounded">Zaloguj</button>
  <span id="loginMsg" class="ml-3 text-sm text-red-500"></span>
</div>

<script>
document.getElementById("loginBtn").addEventListener("click", async () => {
    const user = document.getElementById("loginUser").value;
    const pass = document.getElementById("loginPass").value;
    const body = new URLSearchParams();
    body.append("username", user);
    body.append("password", pass);

    const r = await fetch("/auth/token", {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: body.toString()
    });

    if (!r.ok) {
        document.getElementById("loginMsg").textContent = "Błąd logowania";
        return;
    }
    const j = await r.json();
    localStorage.setItem("access_token", j.access_token);
    document.getElementById("loginMsg").textContent = "zalogowano";
});
</script>

 
</body>
</html>
